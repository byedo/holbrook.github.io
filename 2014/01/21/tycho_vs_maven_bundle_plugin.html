<!DOCTYPE html>
<html>
  <head>
    <!-- meta information -->
<meta charset="utf-8">
<meta name="description" 
      content="# Tycho与Maven-Bundle-Plugin的对比Maven与OSGi天生就是冤家：Maven通过`pom.xml`描述一个产物的全部，而OSGi将这项工作交给了`MANIFEST.MF`。如果仅仅是一些定义信息还好说，但是..." >
<meta name="author" content="Holbrook(wanghaikuo@gmail.com)">

<!-- Enable responsiveness on mobile devices-->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

<!-- title -->
<title>OSGi构建工具：Tycho还是Maven-Bundle-Plugin？ &middot; 心内求法</title>

<!-- icons -->
<link rel="shortcut icon" href="/public/images/favicon.png" />

<!-- stylesheets -->
<link rel="stylesheet" href="/public/css/syntax.css">
<link rel="stylesheet" href="/public/css/responsive.gs.12col.css">
<link rel="stylesheet" href="/public/css/animate.min.css">
<link rel="stylesheet" href="/public/css/main.css">

<!-- Google fonts -->
<link rel="stylesheet" href="/public/css/googleapis.css">


<!-- font Awesome -->
<link href="/public/css/font-awesome.css" rel="stylesheet">


<!-- feed links -->
<link rel="alternate" href="http://thinkinside.tk/feed.xml" type="application/rss+xml" title="">

  </head>
  <body>
    <div class="container">
      <header class="top row gutters">
        <div class="col span_2" id="logo-container">
          <a href="/" id="actual-logo" title="心内求法" style="background-image: url(/public/images/logo.png);"></a>
        </div>
        <nav class="col span_10">
	
  
  <a href="/index.html" title="首页"
     >首页</a>
  
  
  <a href="/pages/archive.html" title="归档"
     >归档</a>
  
  
  <a href="/pages/categories.html" title="分类"
     >分类</a>
  
  
  <a href="/pages/tags.html" title="标签"
     >标签</a>
  
  
  <a href="/feed.xml" title="订阅"
     >订阅</a>
  
  
  <a href="http://www.wumii.com/auto_app/download/nbn2Kljo" title="手机版"
     >手机版</a>
  
</nav>

      </header>

      <style>
.top_line {
  border-top: 1px solid #b3b3b3;
  border-top-width: 1px;
  border-top-style: solid;
  border-top-color: rgb(179, 179, 179);
}

.bottom_line {
  border-bottom: 1px solid #b3b3b3;
  border-bottom-width: 1px;
  border-bottom-style: solid;
  border-bottom-color: rgb(179, 179, 179);
}

</style>

<article class="single-post row gutters bottom_line">
  <div class="bottom_line">
  <h1 style="font-size: 2em;">OSGi构建工具：Tycho还是Maven-Bundle-Plugin？</h1>
  <p>摘要：<br/></p>

  <time class="published" datetime="2014-01-21">2014-01-21
  
&sdot; 分类：
  
    <a href="/pages/categories.html#软件开发-ref">软件开发</a>
    <sup>4</sup>
    &nbsp;
  

  &sdot; 标签： 
  
    <a href="/pages/tags.html#OSGi-ref">OSGi</a>
    <sup>4</sup>
    &nbsp;
  
    <a href="/pages/tags.html#maven-ref">maven</a>
    <sup>5</sup>
    &nbsp;
  

  </time>
</div>

  

  <h1>Tycho与Maven-Bundle-Plugin的对比</h1>

<p>Maven与OSGi天生就是冤家：Maven通过<code>pom.xml</code>描述一个产物的全部，而OSGi将这项工作交给了<code>MANIFEST.MF</code>。</p>

<p>如果仅仅是一些定义信息还好说，但是Maven和OSGi都希望能够描述产物的依赖关系，在使用Maven开发OSGi bundle的时候，就导致了一个问题：</p>

<p>依赖关系到底是在<code>pom.xml</code>中描述，还是在<code>MANIFEST.MF</code>中描述？</p>

<p><a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html">前面提到的Tycho</a>的思路是由<code>MANIFEST.MF</code>自行管理bundle的依赖关系，<code>pom.xml</code>只记录使用maven进行构建时需要的信息，比如maven工程的父子关系、打包时需要的bundle仓库及要发布的目标平台等。</p>

<p>Tycho的这种机制对Eclipse IDE比较友好，在开发期间完全使用IDE的机制进行开发和调试，只有在打包部署时才依赖maven。</p>

<p><a href="http://felix.apache.org/site/apache-felix-maven-bundle-plugin-bnd.html">Apache Felix Maven-Bundle-Plugin</a>
则使用另一套机制：使用Maven-Bundle-Plugin，在开发时可以没有<code>MANIFEST.MF</code>文件！Maven-Bundle-Plugin在<code>pom.xml</code>中复制了一套<code>MANIFEST.MF</code>的元数据，完全可以通过<code>pom.xml</code>文件中的定义生成出完整的<code>MANIFEST.MF</code>文件。</p>

<p>Maven-Bundle-Plugin的这种机制使得工程完全的”maven化”，更适合传统非OSGi开发人员的使用习惯。但是无法很好的利用IDE的开发和调试功能，比如，你可能需要自己搭建一个运行环境从IDE中调用。</p>

<p>两种方式可谓各有千秋。但是Tycho明显基于Equniox和Eclipse，比如，Tycho可以配置Eclipse p2站点作为bundle库。如果要使用Tycho开发和调试Felix，需要搭建一个Eclipse风格的p2站点，将Felix runtime和需要的各种bundle都放到该站点中并发布，然后<a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html#menuIndex2">在Tycho中引用该站点</a>。更详细的说明可以参考<a href="http://vzurczak.wordpress.com/2013/02/27/a-target-platform-based-on-apache-felix/">这里</a>。</p>

<p>而Felix Maven-Bundle-Plugin对于各种OSGi runtime的支持是相同的，由于完全基于maven，使用任何IDE开发bundle的效果都差不多。通常，Felix系的平台，如Karaf、Geronimo、Camel、ServiceMix、Fuse等，其例子都是使用Maven-Bundle-Plugin构建的。</p>

<p>由于<a href="/2014/01/08/build_osgi_bundle_with_tycho_maven_plugin.html">前文已经说明了如何用Tycho开发OSGi</a>，下面只给出使用Maven-Bundle-Plugin的例子。</p>

<h1>Maven-Bundle-Plugin的pom例子</h1>

<p>```
 &lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</p>

<pre><code>xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
&lt;groupId&gt;thinkinside.demo.osgi&lt;/groupId&gt;
&lt;artifactId&gt;simple-bundle&lt;/artifactId&gt;
&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;


&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
            &lt;artifactId&gt;maven-bundle-plugin&lt;/artifactId&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;generate-resources&lt;/id&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;manifest&lt;/goal&gt;
                    &lt;/goals&gt;

                    &lt;configuration&gt;
                        &lt;instructions&gt;
                            &lt;Bundle-Name&gt;${project.name}&lt;/Bundle-Name&gt;
                            &lt;Bundle-SymbolicName&gt;${project.artifactId}&lt;/Bundle-SymbolicName&gt;
                            &lt;Bundle-Activator&gt;test.bundle.internal.Activator&lt;/Bundle-Activator&gt;
                            &lt;Export-Package&gt;***&lt;/Export-Package&gt;
                            &lt;Import-Package&gt;***&lt;/Import-Package&gt;
                            &lt;Private-Package&gt;***&lt;/Private-Package&gt;
                        &lt;/instructions&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;

        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;
            &lt;version&gt;2.3.1&lt;/version&gt;
            &lt;configuration&gt;
                &lt;archive&gt;
                    &lt;manifestFile&gt;${project.build.outputDirectory}/META-INF/MANIFEST.MF&lt;/manifestFile&gt;
                &lt;/archive&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
        &lt;artifactId&gt;org.osgi.core&lt;/artifactId&gt;
        &lt;version&gt;1.4.0&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>

<p> </project>
```</p>

<p>使用Maven-Bundle-Plugin构建bundle，就是构建一个简单的jar。不同之处在于：要通过pom.xml中的信息生成符合OSGi要求的<code>MANIFEST.MF</code>文件并打包到jar中。这通过两个插件来完成：</p>

<ul>
<li><p>org.apache.felix:maven-bundle-plugin</p>

<p>在项目生命周期的"generate-resources"阶段，根据<code>&lt;instructions&gt;</code>标签内定义的信息生成<code>MANIFEST.MF</code>文件。这里可以配置OSGi所需要的全部元数据。</p></li>
<li><p>org.apache.maven.plugins:maven-jar-plugin</p>

<p>配置其在打包是使用前面生成的<code>MANIFEST.MF</code>文件</p></li>
</ul>


<p>由于OSGi bundle通常会使用OSGi API，这里添加了org.apache.felix:org.osgi.core的依赖。当然也可以换成其他的OSGi运行时，比如Equinox。</p>

<p>此时，使用<code>mvn package</code>生成的jar包中，<code>MANIFEST.MF</code>文件内已经添加了配置好的bundle信息。</p>

<p>当然，使用<a href="http://svn.apache.org/repos/asf/felix/releases/maven-bundle-plugin-2.3.7/doc/site/index.html">maven-bundle-plugin的目标(Goals)</a>
可以进行更细致的控制。</p>

<h1>在Eclipse中运行和调试</h1>

<p>本来，传说中的<a href="http://wiki.ops4j.org/confluence/display/ops4j/Pax%20Cursor">Pax Cursor</a>可以在Eclipse中基于各种OSGi runtime运行和调试bundle，但是天朝的网络中似乎不存在<code>ops4j.org</code>这个域名。</p>

<p>好在我们可用一个Java Project的方式建立起Felix的环境，通过Eclipse对bundle进行运行和调试。
由于<a href="http://felix.apache.org/site/integrating-felix-with-eclipse.html">这里</a>有非常详细的说明，故不再赘述。</p>

<p>其实，我们还可以基于maven构建，而不是使用Java Project的方式。使用maven的好处是这种方法可以用于任何支持maven的IDE。</p>

<p>Felix runtime的主要内容包括：</p>

<p><img src="/images/fuse/felix-tree.png" alt="" /></p>

<p>其中：</p>

<ul>
<li>bin/felix.jar  启动的jar, MainClass是<code>org.apache.felix.main.Main</code></li>
<li>bundle/   存放可用的bundle，Felix runtime中内置了4个必需的bundle</li>
<li>conf/conf.properties 启动配置。类似于Eclipse的<code>configuration/config.ini</code>。Felix配置项可以参考<a href="http://felix.apache.org/site/apache-felix-framework-configuration-properties.html">官方网站中的内容</a></li>
</ul>


<p>知道了Felix runtime的构成，就可以用maven构建出相同的结构，并插入到项目周期的适当位置。pom如下：</p>

<p>```
 &lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</p>

<pre><code>xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
&lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
&lt;groupId&gt;thinkinside.demo.fuse&lt;/groupId&gt;
&lt;artifactId&gt;felix-launcher&lt;/artifactId&gt;
&lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
&lt;name&gt;Felix Launcher&lt;/name&gt;
&lt;properties&gt;
    &lt;felix.bundlerepository.version&gt;1.6.4&lt;/felix.bundlerepository.version&gt;
    &lt;felix.gogo.version&gt;0.10.0&lt;/felix.gogo.version&gt;
    &lt;felix.framework.version&gt;4.2.1&lt;/felix.framework.version&gt;
&lt;/properties&gt;

&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;artifactId&gt;maven-clean-plugin&lt;/artifactId&gt;
            &lt;version&gt;2.4.1&lt;/version&gt;
            &lt;configuration&gt;
                &lt;filesets&gt;
                    &lt;fileset&gt;
                        &lt;directory&gt;bundle&lt;/directory&gt;
                    &lt;/fileset&gt;
                &lt;/filesets&gt;
            &lt;/configuration&gt;
        &lt;/plugin&gt;

        &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
            &lt;version&gt;2.2&lt;/version&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;copy&lt;/id&gt;
                    &lt;phase&gt;generate-resources&lt;/phase&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;copy&lt;/goal&gt;
                    &lt;/goals&gt;
                    &lt;configuration&gt;
                        &lt;artifactItems&gt;
                            &lt;artifactItem&gt;
                                &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
                                &lt;artifactId&gt;org.apache.felix.gogo.command&lt;/artifactId&gt;
                                &lt;version&gt;${felix.gogo.version}&lt;/version&gt;
                            &lt;/artifactItem&gt;
                            &lt;artifactItem&gt;
                                &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
                                &lt;artifactId&gt;org.apache.felix.gogo.runtime&lt;/artifactId&gt;
                                &lt;version&gt;${felix.gogo.version}&lt;/version&gt;
                            &lt;/artifactItem&gt;
                            &lt;artifactItem&gt;
                                &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
                                &lt;artifactId&gt;org.apache.felix.gogo.shell&lt;/artifactId&gt;
                                &lt;version&gt;${felix.gogo.version}&lt;/version&gt;
                            &lt;/artifactItem&gt;
                            &lt;artifactItem&gt;
                                &lt;groupId&gt;org.osgi&lt;/groupId&gt;
                                &lt;artifactId&gt;org.osgi.compendium&lt;/artifactId&gt;
                                &lt;version&gt;4.2.0&lt;/version&gt;
                            &lt;/artifactItem&gt;
                        &lt;/artifactItems&gt;
                        &lt;outputDirectory&gt;bundle&lt;/outputDirectory&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;

&lt;/build&gt;

&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.apache.felix&lt;/groupId&gt;
        &lt;artifactId&gt;org.apache.felix.main&lt;/artifactId&gt;
        &lt;version&gt;${felix.framework.version}&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.ops4j.pax.url&lt;/groupId&gt;
        &lt;artifactId&gt;pax-url-assembly&lt;/artifactId&gt;
        &lt;version&gt;1.6.0&lt;/version&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
</code></pre>

<p> </project>
```</p>

<p>该pom在标准的生命周期中增加了两项工作：</p>

<ul>
<li>在<code>generate-resources</code>阶段，创建bundle文件夹，复制必需的4个bundle</li>
<li>在<code>clean</code>阶段，清除bundle文件夹</li>
</ul>


<p>最后，还需要一个配置文件。在工程目录建立<code>/conf/config.properties</code>文件，并进行基本配置：</p>

<p>```
felix.auto.deploy.action=install,start
felix.log.level=1</p>

<p>org.osgi.framework.storage.clean=onFirstInit
```</p>

<p>配置完成了，先执行<code>mvn compile</code>生成需要的资源。此时使用命令<code>mvn exec:java -Dexec.mainClass="org.apache.felix.main.Main"</code>即可以启动Felix runtime：</p>

<p><img src="/images/fuse/felix_launch_from_maven.png" alt="" /></p>

<p>在Eclipse中，将这个工程作为<code>Java Application</code>运行，选择<code>org.apache.felix.main.Main</code>作为Main Class，就可以进行运行和调试。</p>

  <!--百度分享 BEGIN-->
<div class="bdsharebuttonbox" class="top_line">
  <a href="#" class="bds_more" data-cmd="more">分享到：</a><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a><a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a><a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a></div>

<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"2","bdSize":"16"},"share":{"bdSize":16},"image":{"viewList":["tsina","qzone","tqq","renren","weixin"],"viewText":"分享到：","viewSize":"16"},"selectShare":{"bdContainerClass":null,"bdSelectMiniList":["tsina","qzone","tqq","renren","weixin"]}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
<!--百度分享 END-->

      <!--  评论  -->
      <div class="row-fluid">
        
          <!-- UY BEGIN -->
          <div id="uyan_frame"></div>
          <script type="text/javascript" id="UYScript" src="http://v1.uyan.cc/js/iframe.js?UYUserId=1784345" async="true"></script>
          <!-- UY END -->
        
      </div>
      <!--  评论  END -->





</article>

 <!--上一篇，下一篇-->
      <div class="row-fluid">
      
        <div class="span6">
          <a href="/2014/01/22/osgi_blueprint_container.html" rel="bookmark">&laquo;&nbsp;下一篇：Blueprint: OSGi的依赖注入(DI)容器</a>
        </div>
      

      
        <div class="span6">
        <a class="pull-right" href="/2014/01/20/about_fuse_esb.html" rel="bookmark">上一篇：JBOSS FUSE:你必须知道的那些事&nbsp;&raquo;</a>
        </div>
      
      </div>
      <!--上一篇，下一篇 END-->


<!--wumii block-->
          <script type="text/javascript" id="wumiiRelatedItems"></script>


          <!--for wumii ， can be moved to footer-->
         <script type="text/javascript">
            var wumiiPermaLink = "http://thinkinside.tk/2014/01/21/tycho_vs_maven_bundle_plugin.html"; //请用代码生成文章永久的链接
            var wumiiTitle = "OSGi构建工具：Tycho还是Maven-Bundle-Plugin？"; //请用代码生成文章标题
            var wumiiTags = "心内求法,OSGi,maven"; //请用代码生成文章标签，以英文逗号分隔，如："标签1,标签2"
            var wumiiCategories = ["软件开发"]; //请用代码生成文章分类，分类名放在 JSONArray 中，如: ["分类1", "分类2"]
            var wumiiSitePrefix = "http://www.thinkinside.tk/";
            var wumiiParams = "&num=5&mode=3&pf=JAVASCRIPT";
        </script>
        <script type="text/javascript" src="http://widget.wumii.cn/ext/relatedItemsWidget" async="true"></script>
        <a href="http://www.wumii.com/widget/relatedItems" style="border:0;">
            <img src="http://static.wumii.cn/images/pixel.png" alt="无觅相关文章插件，快速提升流量" style="border:0;padding:0;margin:0;" />
        </a>
        <!--end of wumii-->


    </div>
    
    <footer>
       <div class="row">
      <div class="col span_7">
        <p><h4 class="footer-title">心内求法</h4>
        制心一境，住心观性，澄心外照，摄心内证</p>
        
        <p>&copy; Copyright 2014  <a herf='mailto:wanghaikuo@gmail.com'>Holbrook Wong</a>. 
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank">署名-非商业性使用-相同方式共享</a> 
        </p>
        

        <a rel="license nofollow" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" target="_blank"><img alt="知识共享许可协议" style="border-width:0" src="/public/images/footer_cc.png" /></a>

        <a rel="nofollow" href="http://www.alexa.com/siteinfo/thinkinside.tk" target="_blank" class="AlexaSiteStatsWidget"></a>

        <!-- Site Meter -->
        <script type="text/javascript" src="http://s51.sitemeter.com/js/counter.js?site=s51thinkinside" async="true">
        </script>
        <noscript>
        <a href="http://s51.sitemeter.com/stats.asp?site=s51thinkinside" target="_top">
        <img src="http://s51.sitemeter.com/meter.asp?site=s51thinkinside" alt="Site Meter" border="0"/></a>
        </noscript>
      </div> <!-- /span8 -->

      <div class="col span_5">
          <h3>关于</h3>
          <iframe width="100%" height="75" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=75&fansRow=2&ptype=1&speed=0&skin=1&isTitle=0&noborder=0&isWeibo=0&isFans=0&uid=1878878250&verifier=b193b9de&dpc=1"></iframe>
          
          <h5>我以前的博客</h5>
          <a href="http://www.cnblogs.com/holbrook/" target="_blank">@博客园</a>(2012.2--2013.5)<br/>
          <a href="http://blog.csdn.net/thinkinside/" target="_blank">@CSDN</a>(2007.7--2012.2)<br/>
          <a href="http://www.blogjava.net/wanghaikuo" target="_blank">@blogjava</a>(2006.10--2007.7)
        </div>
      </div>
    </div>
 
    </footer>

    <!-- scripts -->
    <!--百度统计-->
    <script type="text/javascript">
    var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
    document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fb942c9f7549938d471dbef766d4b4792' type='text/javascript'%3E%3C/script%3E"));
    </script>
    
    <script src="/public/js/jquery-1.10.2.min.js"></script>
    <script src="/public/js/jquery.fitvids.min.js"></script>
    <script>
      $(document).ready(function(){
        $("article").fitVids();
      });
    </script>
  </body>
</html>
