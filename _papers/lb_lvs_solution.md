---
layout: post
title: "LVS负载均衡方案"
description: ""
category: 解决方案
tags: [负载均衡]
---

服务器集群和负载均衡的方式目前主要有DNS轮询、CDN（内容分发网络）和IP负载均衡。
其中DNS的方式简单经济，但是可靠性很差；CDN适合静态内容为主的网站；IP负载均衡是最常用的负载均衡技术。

从实现方式上，IP负载均衡可以分为硬件负载均衡（如F5）和软件负载均衡（如LVS、NginX、HAProxy)。

信息技术中心之前实施了基于NginX的负载均衡方案，使用NginX反向代理多个应用服务器，实现应用服务器的负载均衡，
并通过NginX对域名和虚拟目录进行统一的管理。
经过半年多的使用，该方案收到了良好的效果，已经应用到外网、办公网和内网的多个应用系统。

对于外部应用系统，信息技术中心使用F5来解决链路负载均衡的问题，根据用户的网络情况选择不同ISP的链路连接到服务器。

从公司整体基础设施架构的角度来看，目前的架构还有存在一些问题和改进之处：

1. F5价格比较昂贵，而且配置相对复杂，扩展的弹性不足。
2. 现有的NginX采用主备方式实现HA，只有单个节点工作。
   在目前的虚拟机环境下每秒处理请求约2.4万，最大并发用户数为700左右。
   这样的负载能力不足以支撑互联网应用。
3. 不具备广域域负载均衡的能力，无法在总部和灾备中心之间进行负载调度。机房和灾备中心不能同时提供服务。

本方案在现有NginX的基础上，进一步使用LVS代替F5作为负载均衡器，并补充必要的其他架构组件，以其解决上述问题。


# 现状说明

下图是目前公司的外网应用架构：

![AS-IS](../images/2013/lb_lvs_solution/as-is.png)

1. F5 负责Web服务器的负载均衡，支持多链路负载均衡
2. NginX 负责应用服务器负载均衡，支持域名、虚拟目录的重定向
3. 如果同时需要多链路负载均衡和虚拟目录重定向功能，需要F5与Nginx级联
4. F5 为双节点集群方式，NginX为双节点主备方式 

# 架构方案

现有的架构从实现方式上不够统一，不能实现广域负载均衡，而且F5的性价比不高。为此提出如下的架构方案：

![TO-BE](../images/2013/lb_lvs_solution/to-be.png)

1. LVS工作在4层，实现多链路和广域的负载均衡
2. NginX工作在7层，实现域名和虚拟目录管理、会话保持、访问控制等功能
3. 每个区域的LVS均为多节点集群
4. NginX从主备方式改为多节点集群方式，解决负载能力不足的问题

## LVS简介

LVS是上述架构中的核心组件。

[LVS(Linux Virtual Server,Linux虚拟服务器)](http://www.linuxvirtualserver.org/)，是由[章文嵩博士](http://zh.linuxvirtualserver.org/)发起的开源软件(GPL许可）。现在LVS已经是Linux内核(>2.4)的一个内置模块，同时支持FreeBSD系统。

LVS工作在4层，支持大多数的TCP和UDP协议。支持TCP协议的应用有：HTTP，HTTPS ，FTP，SMTP，POP3，IMAP4，PROXY，LDAP，SSMTP等。支持UDP协议的应用有：DNS，NTP，ICP，视频、音频流播放协议等。可以用于Web服务、Cache服务、DNS服务、FTP服务、MAIL服务、视频/音频点播服务等。

LVS具有极高的性能，经实际测试每秒处理xxx,最大并发xxx并发


## 负载均衡

![负载均衡](../images/2013/lb_lvs_solution/loadbalance.png)

客户端访问的是LVS提供的一个VIP(Virtual IP,虚拟IP)。LVS根据一定的调度策略和后端服务器的状态将请求转发到真实服务器(Real Server)。
根据所采用的实现技术不同，真实服务器可以将应答报文直接返回客户端或者经过LVS返回客户端。

LVS支持[多种负载均衡的实现技术](http://thinkinside.tk/2013/06/02/lvs_lb_strategy.html)，包括VS/NAT, VS/TUN, VS/DR和VS/FULLNAT。





## 广域、多链路负载均衡

## LVS集群

## LVS方式

## 管理和维护

## 性能测试

实验环境：LVS-->NginX(2)

---
4. 文件同步，共享存储，内容分发，自动部署等
5. 可管理性
---


文件同步，共享存储，内容分发，自动部署等
  SQUID缓存1.登录后点击左侧按钮，将本资流分享出去；CDN


# 实施计划

1. 先外网，后内网
2. 先总部，后新疆
3. 逐步增加cache 服务器等

# 方案扩展

要实现总部机房和灾备机房同时对外提供服务，除了解决广域负载均衡问题外，还需要一系列的配套设施才能实现。

可以有两种方式实现：CDN方式和分布式架构方式。

## CDN方式

## 分布式架构方式

这种方式比较复杂，但是实现了真正的双活、双中心，能极大提高灾备中心的资源利用效率。
分布式架构如下图所示：


其中有一些关键的技术问题需要解决：
1. 虚拟IP管理
尽管在内部网络中有DNS，但是重要的IP地址最好虚拟化。
LVS工作在四层，不仅可以用于web服务器的负载均衡，还可以应用在更多场合，比如db(mysql）
交由lvs托管，比如数据库的ip、webservice服务器的ip等等，这些ip地址随着时间推移，使用面会越来越大，如果更换ip则故障会接踵而至。所以将这些重要ip交给lvs托管是最为稳妥的，这样做的唯一缺点是需要的VIP数量会比较多。
1. 分布式文件系统
2. 应用发布和自动部署
3. 数据库实时同步
4. 数据库集群
   - LVS可以作为mysql集群的前端负载均衡器
   - oracle:?





