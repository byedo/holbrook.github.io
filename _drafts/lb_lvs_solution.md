LVS负载均衡方案

摘要：

IP负载均衡是与DNS轮询、CDN(内容分发网络)并列的一种负载均衡集群技术。
对IP负载均衡的实现既有硬件设备（如F5）又有软件方式（如LVS、NginX、HAProxy)。

信息技术中心现有的基础设施架构中，使用F5和NginX分别实现链路负载均衡和web负载均衡。

LVS是另一种IP负载均衡软件。与NginX相比，LVS的并发能力可以提高2个数量级；与F5相比，LVS能够以很低的成本达到相同数量级的并发能力，并且具备更高的可定制性。

本方案试图结合LVS与NginX，构建一种高并发、低成本、可定制、易维护的负载均衡集群架构，以期替代F5并提供更好的特性。

LVS具备广泛的适用性，除Web负载均衡外，还可用于很多场景。随着摩尔定律的失效，分布式架构会越来越成为企业应用的首选架构。
在很多分布式架构中，LVS都可以发挥重要的作用。在本方案的最后，列举一些常见的LVS的应用场景，可以作为今后其他架构设计时的参考。

目录：



# 现状分析

信息技术中心之前实施了基于NginX的负载均衡方案，使用NginX反向代理多个应用服务器，实现应用服务器的负载均衡，
并通过NginX对域名和虚拟目录进行统一的管理。
经过半年多的使用，该方案收到了良好的效果，已经应用到外网、办公网和内网的多个应用系统。

对于互联网系统，信息技术中心使用F5来解决链路负载均衡的问题，根据用户的网络情况选择不同ISP的链路连接到服务器。
如下图：

![AS-IS](../images/2013/lb_lvs_solution/as-is.png)

1. F5 负责Web服务器的负载均衡，支持多链路负载均衡
2. NginX 负责应用服务器负载均衡，支持域名、虚拟目录的重定向
3. 如果同时需要多链路负载均衡和虚拟目录重定向功能，需要F5与Nginx级联
4. F5 为双节点集群方式，NginX为双节点主备方式 

从公司整体基础设施架构的角度来看，目前的架构还有存在一些问题和改进之处：

1. F5价格比较昂贵，而且配置相对复杂，扩展的弹性不足。
2. 现有的NginX采用主备方式实现HA，只有单个节点工作。
   在目前的虚拟机环境下每秒处理请求约2.4万，最大并发用户数为700左右。
   这样的负载能力不足以支撑互联网应用。
3. 不同的应用系统采用不同的架构方案，带来复杂性。



# F5、NginX、LVS的分析和对比

## F5的特性

F5的全称是F5 BIG-IP，[F5 Networks公司](http://www.f5.com/)研发的著名的硬件负载均衡设备。支持4层、7层负载均衡，并发能力可以达到400万--800万（取决于不同的型号）。F5的主要功能包括：

1. 多链路的负载均衡和冗余
   
   可以接入多条ISP链路，在链路之间实现负载均衡和高可用。

2. 防火墙负载均衡

   F5具有异构防火墙的负载均衡与故障自动排除能力。

3. 服务器负载均衡

   这是F5最主要的功能，F5可以配置针对所有的对外提供服务的服务器配置Virtual Server实现负载均衡、健康检查、回话保持等。

4. 高可用

   F5设备自身的冗余设计能够保证99.999%的正常运行时间，双机F5的故障切换时间为毫秒级。

   使用F5可以配置整个集群的链路冗余和服务器冗余，提高可靠的健康检查机制，以保证高可用。

5. 安全性

   与防火墙类似，F5采用缺省拒绝策略，可以为任何站点增加额外的安全保护，防御普通网络攻击，包括DDoS、IP欺骗、SYN攻击、teartop和land攻击、ICMP攻击等。

6. 易于管理

   F5提供HTTPS、SSH、Telnet、SNMP等多种管理方式，包含详尽的实时报告和历史纪录报告。同时还提供二次开发包(i-Control)。

7. 其他

   F5还提供了SSL加速、软件升级、IP地址过滤、带宽控制等辅助功能。

目前，公司内部主要使用上述1、3、4功能实现应用系统的多链路负载均衡，以提高其并发能力和高可用性；对于LVS的7层负载调度功能利用得不够充分。

## NginX的特性
 
NginX是应用比较广泛的七层负载均衡软件。由于NginX工作在7层，可以按照http协议中的数据（如URL、cookie等）进行负载调度。NginX配置简单，对网络条件的要求也很少。NginX可以支持3--5万的并发连接（7层）。

## LVS的特性

[LVS(Linux Virtual Server, Linux虚拟服务器)](http://www.linuxvirtualserver.org/)是一种软件的负载均衡器。

LVS工作在4层，支持大多数的TCP和UDP协议。支持TCP协议的应用有：HTTP，HTTPS ，FTP，SMTP，POP3，IMAP4，PROXY，LDAP，SSMTP等。支持UDP协议的应用有：DNS，NTP，ICP，视频、音频流播放协议等。可以用于Web服务、Cache服务、DNS服务、FTP服务、MAIL服务、视频/音频点播服务等。LVS具有极高的性能，可以支撑上百万的并发连接。

LVS是章文嵩博士在1998年发起的开源项目，遵循GPL许可。现在LVS已经集成到Linux内核中(>2.4)，并且支持FreeBSD系统。


LVS实现了基于IP技术的负载均衡，提供3种负载均衡机制：

- VS/NAT（基于网络地址转换技术）
- VS/TUN（基于IP隧道技术）
- VS/DR（基于直接路由技术）

三种机制的详细说明参考[这里](/2013/06/02/lvs_lb_strategy.html)。

在三种机制的基础上，LVS还提供了多种负载调度（Scheduling）策略。包括：

- rr（Round Robin）, 平均分配负载
- wrr（Weighted Round Robin），在rr的基础上增加权重设置
- lc（Least-Connections），分配给连接数最少的服务器
- wlc（Weighted Least-Connections），在lc的基础上增加权重设置
- lblc（Locality-Based Least Connections），在lc的基础上将相同目标IP地址的请求调度到同一台服务器。通常用于缓冲（Cache）集群，可以提高各缓存服务器的访问局部性和Cache命中率
- lblcr（Locality-Based Least Connections with Replication），与lblc类似，只不过同一个目标IP地址会映射到一组缓存服务器
- dh（Destination Hashing），根据目标地址的Hash运算结果进行分配，通常用于链路负载均衡
- sh（Source Hashing），根据请求客户端地址的Hash运算结果进行分配，可以实现某种程度的会话保持（Session Persistence)
- sed（Shortest Expected Delay），在wlc的基础上，进一步计算出期望延迟，向`(1+已有连接数)/权重`最小者分配请求
- nq（Never Queue），无队列调度。直接分配给当前无连接的服务器



## LVS与F5、NginX的对比

与F5 BIG-IP相比，LVS虽然支持的并发连接较少，但处于同一个数量级（百万并发）。使用LVS需要自己解决配置、图形化监控等功能（可以通过第三方的软件）。 而带来的好处就是降低成本和完全的可定制性。

与NginX相比，LVS并发处理能力要高2个数量级。但这种能力的提高是以相对复杂的网络条件和配置步骤为代价的。同时，LVS无法根据http协议的内容进行负载调度。LVS不能处理7层的协议内容，但是使用的范围更广泛，可以对绝大多数的TCP和UDP协议的请求进行调度。LVS也可以作为NginX的前端。

# LVS技术验证和测试

经过在测试环境对LVS的安装、配置和管理、监控操作，以及初步的性能测试，得出以下结论：

1. 信息技术中心内部完全可以掌握LVS的应用
2. 验证了LVS的负载调度功能
3. 验证了LVS的后端服务健康监测功能
4. 验证了在增加后端服务节点的情况下，使用LVS的整个集群的并发能力以接近线性的方式提高
5. 没有测试到LVS能够管理的后端节点个数的极限值
6. 使用LVS对http请求进行调度，比直接访问后端服务器会增加50ms左右的响应时间
 
# 架构方案

## 总体架构


![TO-BE](../images/2013/lb_lvs_solution/to-be.png)

1. LVS工作在4层，绑定两个VIP，分别连接到电信和联通线路，实现链路负载均衡
2. 通过Keepalived将两个LVS节点配置为互相备份，从而实现LVS节点的双活
2. NginX工作在7层，实现域名和虚拟目录管理、访问控制等功能
3. 根据应用系统的分组，不同的NginX连接到不同的后端服务
4. 所有的NginX节点同时为活跃节点，可以随时横向扩展
5. LVS选择`Source Hashing`调度策略，NginX的配置上增加`ip_hash`选项，从而实现整个访问通道上的会话保持
6. 通过第三方的[net-snmp-lvs-module](http://kb.linuxvirtualserver.org/wiki/Net-SNMP-LVS-Module)模块提供对LVS的SNMP监控

## 负载能力评估

该架构中，NginX节点可以扩展至几百台，应用服务器可以扩展至上千台。最终负载能力受限于LVS节点。

根据现有的一些测试数据和官方的性能报告进行估算，该架构在充分扩展和优化的情况下，理论并发连接数可以达到200万以上。


# 实施计划

为了降低风险和影响程度，建议先在内部管理系统上进行试用，经过一段时间的成熟稳定运行后再考虑替换外部系统的F5。

# LVS的其他用途

本方案中使用LVS作为web服务器的前端负载均衡器。但是由于LVS工作在4层，所有工作在TCP/IP之上的应用或服务都可以通过LVS建立负载均衡集群以提高并发能力。LVS的其他典型用途如下：

- web缓存及反向代理

  web缓存及反向代理位于web服务器之前，可以缓存静态内容，只把动态内容的请求反向代理到后端的web服务器。常见的web缓存服务器如Squid，NginX都可以使用LVS构建集群系统。

- web服务器/应用服务器

  LVS可以作为web服务器/应用服务器（如Nginx,Apache,Tomcat等）的前端调度器，支持会话保持功能。LVS + NginX的组合可以代替F5 BIG-IP的功能，并能达到低端BIG-IP的性能。

- 数据库服务器

  典型的mysql主-从集群中，LVS可以作为多个从服务器的负载调度器。

- 重要IP的管理

  对于重要的IP地址（如ESB、数据库、中间件等），可以交给LVS进行统一管理，避免更换IP带来的故障和问题。



